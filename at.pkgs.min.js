(at=this.at||{}).pkgs=new (function(_root_){this.Object=(function(_namespace_){var _class_;_class_=function(instance){};_class_.extend=function(constructor,prototype,statics){var closure;var name;closure=new Function();closure.prototype=this.prototype;constructor.prototype=new closure();name=null;if(prototype){for(name in prototype){constructor.prototype[name]=prototype[name]}}constructor.prototype.self=constructor;constructor.prototype.parent=this.prototype;for(name in this){if(name=="prototype"){continue}constructor[name]=this[name]}if(statics){for(name in statics){constructor[name]=statics[name]}}return constructor};_class_.prototype.self=_class_;_class_.prototype.parent=null;return _class_})(this);this.Log=(function(_namespace_){var _class_;_class_=_namespace_.Object.extend((function(name,instance){instance=instance||this;this.parent.self(instance);instance.level=this.self.INFO;instance.name=name}),{level:null,name:null,stack:function(error){var stack;if(!error.stack){return false}stack=error.stack.toString().match(/^.*$/gm);if(stack[0].match(/^Error/)){stack.shift()}else{}stack.shift();stack.shift();return stack.join("\n")},log:function(level,parameters,trace){var message;if(this.level<level){return false}if(!this.self.append()){return false}if(parameters.length<1){return true}message="["+this.self.LEVELS[level]+"] ";message+=this.name+": ";message+=this.self.format.apply(this,parameters);try{if(!trace){throw new Error()}}catch(error){trace=this.stack(error)}return this.self.append(message,trace)},debug:function(template,parameter){return this.log(this.self.DEBUG,arguments)},info:function(template,parameter){return this.log(this.self.INFO,arguments)},error:function(template,parameter){return this.log(this.self.ERROR,arguments)},_catch_:function(error){this.log(this.self.ERROR,[error.toString()],error.stack);return this},_throw_:function(error){this._catch_(error);throw error},trap:function(callback,suppress,inject){var log;log=this;return function(){try{if(inject){callback.log=log}callback.apply(this,arguments)}catch(error){suppress?log._catch_(error):log._throw_(error)}}}},{LEVELS:["ERROR","INFO","DEBUG"],ERROR:0,INFO:1,DEBUG:2,instances:{},get:function(name){if(!this.instances[name]){this.instances[name]=new this(name)}return this.instances[name]},debug:function(name){this.get(name).level=this.DEBUG;return this},append:function(message,trace){if(!(_root_.console&&_root_.console.log)){return false}if(arguments.length<1){return true}_root_.console.log(message+(trace?("\n"+trace):""));return true},format:function(template,parameter){var parameters;if(!parameter){return template}parameters=arguments;return template.replace(/\{(\d*)?(:\w*)?\}/g,function(matched,index,name){var value;index=index?parseInt(index,10):0;value=parameters[index+1];return name?value[name.substring(1)]:value})}});return _class_})(this);this.EventBinder=(function(_namespace_){var _class_;_class_=_namespace_.Object.extend((function(instance){instance=instance||this;this.parent.self(instance);instance.handlers=new Array()}),{handlers:null,bind:function(handler,top){if(top){this.handlers.unshift(handler)}else{this.handlers.push(handler)}return this},unbind:function(handler){var index;index=0;while(index<this.handlers.length){if(this.handlers[index]==handler){this.handlers.splice(index,1)}index++}return this},clear:function(){this.handlers.length=0;return this},fire:function(){var index;var handler;for(index=0;index<this.handlers.length;index++){handler=this.handlers[index];if(handler.apply(handler,arguments)===false){break}}return this}});return _class_})(this);this.ObservableValue=(function(_namespace_){var _class_;_class_=_namespace_.EventBinder.extend((function(value,instance){instance=instance||this;this.parent.self(instance);instance.value=value}),{value:null,set:function(value){var previous;previous=this.value;this.value=value;if(this.changed(previous,value)){this.fire(previous,value)}},get:function(){return this.value},changed:function(previous,current){return previous!==current}});return _class_})(this);this.escape=new (function(_parent_){this.empty=(function(_namespace_){var _function_;_function_=function(source){return(source===null||source===void 0)?"":source.toString()};return _function_})(this);this.html=(function(_namespace_){var _function_;_function_=function(source){return _namespace_.empty(source).replace(/[&<>"']/g,function(matched){switch(matched){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";case"'":return"&#039;"}})};return _function_})(this)})(this);this.Template=(function(_namespace_){var _class_;_class_=_namespace_.Object.extend((function(source,engine,instance){instance=instance||this;this.parent.self(instance);instance.engine=engine;instance.texts=new Array();instance.prepare(source)}),{engine:null,texts:null,code:null,prepare:function(source){var self;var codes;var last;self=this;codes=new Array();if(source===null||source===void 0||!source.replace){throw new Error("invalid template source")}last=0;source.replace(this.engine.pattern,function(matched,code,escape,raw,offset){var expression;if(last!=offset){codes.push("_text_ += _this_.text("+self.texts.length+");");self.texts.push(source.slice(last,offset))}last=offset+matched.length;expression=code||escape||raw;if(code){codes.push(expression)}if(escape){codes.push("_text_ += _this_.escape("+expression+");")}if(raw){codes.push("_text_ += _this_.raw("+expression+");")}return matched});this.code=codes.join("\n")},text:function(index){return this.texts[index]},escape:function(source){return this.engine.escape(source)},raw:function(source){return this.engine.raw(source)},render:function(_data_){var _this_;var _text_;_this_=this;_text_="";with(_data_||{}){eval(_this_.code)}return _text_}});return _class_})(this);this.TemplateEngine=(function(_namespace_){var _class_;_class_=_namespace_.Object.extend((function(instance){instance=instance||this;this.parent.self(instance)}),{pattern:/\{%(.*?)%\}|\{=(.*?)=\}|\{@(.*?)@\}|$/g,escape:_namespace_.escape.html,raw:_namespace_.escape.empty,prepare:function(source){var template;var renderer;template=new _namespace_.Template(source,this);renderer=function(data){return template.render(data)};renderer.template=template;return renderer}});_class_.instance=new _class_();return _class_})(this);this.template=(function(_namespace_){var _function_;_function_=function(source){return _namespace_.TemplateEngine.instance.prepare(source)};return _function_})(this)})(this);